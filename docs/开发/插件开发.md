---
slug: /develop/plugin4p
---

:::info

æ¬¢è¿åŠ ç¾¤ 322154837 è®¨è®ºã€‚

:::

## å¦‚ä½•å¼€å‘

- clone AstrBot é¡¹ç›®æœ¬ä½“åˆ°æœ¬åœ°ã€‚
- æ‰“å¼€ [helloworld](https://github.com/Soulter/helloworld)ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªæ’ä»¶æ¨¡æ¿ï¼Œæ¥ä¸‹æ¥åœ¨è¿™ä¸ªæ¨¡æ¿ä¸ŠäºŒæ¬¡å¼€å‘ã€‚
- ç‚¹å‡»å³ä¸Šè§’çš„ Use this templateï¼Œç„¶åç‚¹å‡» Create new repositoryã€‚
- åœ¨ Repository name å¤„è¾“å…¥ä½ çš„æ’ä»¶åå­—ï¼Œä¸è¦ä¸­æ–‡ã€‚å»ºè®®ä»¥ `astrbot_plugin_` å¼€å¤´ï¼Œå¦‚ `astrbot_plugin_yuanshen`ã€‚
  - ![image](https://github.com/Soulter/AstrBot-docs/assets/37870767/560fa66f-740a-456c-a6dc-3766a79d3e9f)
- clone åˆ›å»ºå¥½çš„ä»“åº“ã€‚ï¼ˆæœ‰å…³æ€ä¹ˆ cloneï¼Œè¯·è‡ªè¡Œå‚è€ƒå…¶ä»–ç½‘ç»œæ•™ç¨‹ï¼‰
- å°† clone å¥½çš„æ’ä»¶å·¥ç¨‹å¤åˆ¶åˆ° AstrBot çš„ addons/plugins/ ç›®å½•ä¸‹ã€‚
- ä½¿ç”¨ VSCodeã€PyCharm ç­‰ IDE æ‰“å¼€ AstrBot é¡¹ç›®ã€‚
- æ‰“å¼€ `addons/plugins/<ä½ çš„æ’ä»¶å>/metadata.yaml`ã€‚ä½ åº”è¯¥èƒ½çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š
    ```yaml
    name: helloworld # è¿™æ˜¯ä½ çš„æ’ä»¶çš„å”¯ä¸€è¯†åˆ«åã€‚
    desc: è¿™æ˜¯ AstrBot çš„é»˜è®¤æ’ä»¶ã€‚
    help: 
    version: v1.3 # æ’ä»¶ç‰ˆæœ¬å·ã€‚æ ¼å¼ï¼šv1.1.1 æˆ–è€… v1.1
    author: Soulter # ä½œè€…
    repo: https://github.com/Soulter/helloworld # æ’ä»¶çš„ä»“åº“åœ°å€
    ```

## å¼€å‘åçš„æ’ä»¶å¦‚ä½•ä½¿ç”¨ï¼Ÿ
- å¼€å‘å®Œæ¯•åï¼Œå°†æ’ä»¶æ¨é€è‡³ GitHubã€‚
- ä¸Šä¼ å¥½åä½¿ç”¨æŒ‡ä»¤ `plugin i ä»“åº“åœ°å€` è¿›è¡Œå¯¼å…¥ã€‚å¦‚ `plugin i https://github.com/Soulter/helloworld`
- å¼€å‘å¥½çš„æ’ä»¶å¯ä»¥é€šè¿‡ issue æäº¤è‡³æ­¤é¡¹ç›®ï¼Œæˆ‘ä»¬ä¼šå°†å…¶æ”¾è‡³ç›¸åº”ä½ç½®ä¾›ç”¨æˆ·å®‰è£…ã€‚


## æœ€å°å®ä¾‹

```py
from util.plugin_dev.api.v1.bot import Context, AstrMessageEvent, CommandResult
from util.plugin_dev.api.v1.config import *

class Main:
    """
    AstrBot ä¼šä¼ é€’ context ç»™æ’ä»¶ã€‚
    
    - context.register_commands: æ³¨å†ŒæŒ‡ä»¤
    - context.register_task: æ³¨å†Œä»»åŠ¡
    - context.message_handler: æ¶ˆæ¯å¤„ç†å™¨(å¹³å°ç±»æ’ä»¶ç”¨)
    """
    def __init__(self, context: Context) -> None:
        self.context = context
        self.context.register_commands("helloworld", "helloworld", "å†…ç½®æµ‹è¯•æŒ‡ä»¤ã€‚", 1, self.helloworld)

    """
    æŒ‡ä»¤å¤„ç†å‡½æ•°ã€‚
    
    - éœ€è¦æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šmessage: AstrMessageEvent, context: Context
    - è¿”å› CommandResult å¯¹è±¡
    """
    def helloworld(self, message: AstrMessageEvent, context: Context):
        return CommandResult().message("Hello, World!")
```


## Context

æ’ä»¶å¤„ç†å‡½æ•°çš„å‚æ•°ä¹‹ä¸€ã€‚

å®ƒæ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒåŒ…å«äº† AstrBot å®ä¾‹ä¸­çš„ä¸€äº›å…±äº«æ•°æ®ã€‚

åœ¨æ’ä»¶ç±»çš„ `__init__` æ–¹æ³•ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ `context` å‚æ•°è·å–åˆ°è¿™ä¸ªå¯¹è±¡ã€‚

### å±æ€§

è¿™é‡Œä»…ç­›é€‰å‡ºå¯¹æ’ä»¶å¼€å‘æœ‰å¸®åŠ©çš„éƒ¨åˆ†å±æ€§å’Œæ–¹æ³•ã€‚

```py
class Context:
    def __init__(self):
        self.base_config: dict = None  # é…ç½®ï¼ˆæœŸæœ›å¯åŠ¨æœºå™¨äººåæ˜¯ä¸å˜çš„ï¼‰
        self.config_helper: CmdConfig = None # é…ç½®è·å–å™¨
        self.cached_plugins: List[RegisteredPlugin] = []  # æ³¨å†Œçš„æ’ä»¶
        self.platforms: List[RegisteredPlatform] = [] # æ³¨å†Œçš„å¹³å°
        self.llms: List[RegisteredLLM] = [] # æ³¨å†Œçš„å¤§è¯­è¨€æ¨¡å‹
        
        self.unique_session = False # æ˜¯å¦å¼€å¯äº†ç‹¬ç«‹ä¼šè¯
        self.version: str = None  # æœºå™¨äººå½“å‰ç‰ˆæœ¬
        self.nick = None  # gocq çš„å”¤é†’è¯ï¼Œåˆ—è¡¨
        self.t2i_mode = False # æ˜¯å¦å¼€å¯äº†æ–‡æœ¬è½¬å›¾ç‰‡
        self.web_search = False  # æ˜¯å¦å¼€å¯äº†ç½‘é¡µæœç´¢
        self.reply_prefix = "" # å›å¤å‰ç¼€

        self.image_renderer = TextToImageRenderer() # æ–‡æœ¬è½¬å›¾ç‰‡æ¸²æŸ“å™¨
        self.image_uploader = ImageUploader() # å›¾ç‰‡ä¸Šä¼ å™¨
        self.message_handler = None # see astrbot/message/handler.py
```

### context.cached_plugins

è¿™æ˜¯ä¸€ä¸ªåˆ—è¡¨ `List[RegisteredPlugin]`ï¼ŒåŒ…å«äº†æ‰€æœ‰å·²æ³¨å†Œçš„æ’ä»¶ã€‚

```py
@dataclass
class RegisteredPlugin:
    '''
    æ³¨å†Œåœ¨ AstrBot ä¸­çš„æ’ä»¶ã€‚
    '''
    metadata: PluginMetadata
    plugin_instance: object
    module_path: str
    module: ModuleType
    root_dir_name: str
    trig_cnt: int = 0

@dataclass
class PluginMetadata:
    '''
    æ’ä»¶çš„å…ƒæ•°æ®ã€‚
    '''
    plugin_name: str # æ’ä»¶å
    plugin_type: PluginType # æ’ä»¶ç±»å‹
    author: str  # æ’ä»¶ä½œè€…
    desc: str  # æ’ä»¶ç®€ä»‹
    version: str  # æ’ä»¶ç‰ˆæœ¬

class PluginType(Enum):
    PLATFORM = 'platform'  # å¹³å°ç±»æ’ä»¶ã€‚
    LLM = 'llm'  # å¤§è¯­è¨€æ¨¡å‹ç±»æ’ä»¶
    COMMON = 'common'  # å…¶ä»–æ’ä»¶

```

### context.platforms

è¿™æ˜¯ä¸€ä¸ªåˆ—è¡¨ `List[RegisteredPlatform]`ï¼ŒåŒ…å«äº†æ‰€æœ‰å·²æ³¨å†Œçš„å¹³å°ã€‚

```py
@dataclass
class RegisteredPlatform:
    '''
    æ³¨å†Œåœ¨ AstrBot ä¸­çš„å¹³å°ã€‚å¹³å°åº”å½“å®ç° Platform æ¥å£ã€‚
    '''
    platform_name: str # å¹³å°å
    platform_instance: Platform # å¹³å°å®ä¾‹
    origin: str = None  # æ³¨å†Œæ¥æº

```
å€Ÿæ­¤å¯ä»¥è·å–åˆ°æ‰€æœ‰å·²æ³¨å†Œçš„å¹³å°ï¼Œç„¶åé€šè¿‡å¹³å°å®ä¾‹ platform_instance çš„ send_msg æ–¹æ³•å‘é€æ¶ˆæ¯ã€‚è¯¦è§ä¸‹æ–‡ï¼š`ä¸»åŠ¨å‘é€æ¶ˆæ¯`ã€‚

### context.llms

è¿™æ˜¯ä¸€ä¸ªåˆ—è¡¨ `List[RegisteredLLM]`ï¼ŒåŒ…å«äº†æ‰€æœ‰å·²æ³¨å†Œçš„å¤§è¯­è¨€æ¨¡å‹ã€‚

```py
@dataclass
class RegisteredLLM:
    '''
    æ³¨å†Œåœ¨ AstrBot ä¸­çš„å¤§è¯­è¨€æ¨¡å‹è°ƒç”¨ã€‚å¤§è¯­è¨€æ¨¡å‹åº”å½“å®ç° LLMProvider æ¥å£ã€‚
    '''
    llm_name: str
    llm_instance: LLMProvider
    origin: str = None  # æ³¨å†Œæ¥æº
```

#### å‘å¤§è¯­è¨€æ¨¡å‹å‘é€æ¶ˆæ¯

åœ¨ `llm_instance` ä¸Šè°ƒç”¨ `text_chat` æ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå³å¯å‘å¤§è¯­è¨€æ¨¡å‹å‘é€æ¶ˆæ¯ã€‚æ³¨æ„è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ã€‚

> å‰ææ˜¯è‡³å°‘æœ‰ä¸€ä¸ªå¤§è¯­è¨€æ¨¡å‹å·²ç»æ³¨å†Œã€‚æ³¨æ„ `context.llms` æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œå¯èƒ½æœ‰å¤šä¸ªå¤§è¯­è¨€æ¨¡å‹ã€‚å†…ç½®çš„ OpenAI API å¯¹åº”çš„ llm_name ä¸º`internal_openai`ã€‚

```py
# è°ƒç”¨å†…ç½®çš„ OpenAI API å‘é€æ¶ˆæ¯ã€‚
# session_id æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œç”¨äºæ ‡è¯†ä¼šè¯ã€‚ä»»æ„å­—ç¬¦ä¸²ã€‚
llm_instance = None
for llm in context.llms:
    if llm.llm_name == 'internal_openai':
        llm_instance = llm.llm_instance
        break
ret = await llm_instance.text_chat("ä½ å¥½", session_id)

# å¦‚æœä½ åœ¨ä½¿ç”¨ gpt-4o ç­‰å…·æœ‰å›¾ç‰‡ç†è§£èƒ½åŠ›çš„å¤§è¯­è¨€æ¨¡å‹ï¼Œå¯ä»¥ï¼š

ret = await llm_instance.text_chat("ä½ å¥½", session_id, image_url="https://xxxxx")
```

### context.image_uploader

è¿™æ˜¯ä¸€ä¸ª `ImageUploader` å¯¹è±¡ï¼Œç”¨äºä¸Šä¼ å›¾ç‰‡ã€‚æ³¨æ„è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ã€‚

```py
image_url = await context.image_uploader.upload_image("path/to/xxx.jpg")
```

### context.image_renderer

è¿™æ˜¯ä¸€ä¸ª `TextToImageRenderer` å¯¹è±¡ï¼Œç”¨äºå°† markdown æ ¼å¼çš„æ–‡æœ¬æ¸²æŸ“æˆå›¾ç‰‡ã€‚æ³¨æ„è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ã€‚

```py
# è·å¾—å›¾ç‰‡è·¯å¾„
image_path = await context.image_renderer.render("Hello, World!")

# è·å¾—å›¾ç‰‡çš„ url
image_url = await context.image_renderer.render("Hello, World!", return_url=True)
```

> æœªæ¥å°†æ”¯æŒæ’ä»¶è‡ªå®šä¹‰æ¸²æŸ“é£æ ¼ã€‚

### æ³¨å†Œå¼‚æ­¥ä»»åŠ¡ context.register_task()

å¦‚æœä½ éœ€è¦æ¥å…¥ä¸€ä¸ªå…¶ä»–çš„å¹³å°ï¼Œæˆ–è€…éœ€è¦å®šæ—¶ä»»åŠ¡ç­‰ï¼Œé™¤äº†ç›´æ¥ä½¿ç”¨ threading.Thread ä¹‹å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ context.register_task æ³¨å†Œä¸€ä¸ªä»»åŠ¡ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œéœ€è¦ç”¨åˆ°ä¸»åŠ¨å‘é€æ¶ˆæ¯çš„åœºæ™¯ä¸€èˆ¬æ˜¯åå°é•¿ä»»åŠ¡ã€‚è¿™æ—¶å€™ï¼Œä½ å¯ä»¥ä½¿ç”¨ `context.register_task` æ³¨å†Œä¸€ä¸ªä»»åŠ¡ã€‚

åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå°†æ¼”ç¤ºä¸€ä¸ªæ¯éš” 5 ç§’å‘é€ä¸€æ¬¡æ¶ˆæ¯çš„ä»»åŠ¡ã€‚

```py
import asyncio
from util.plugin_dev.api.v1.bot import Context, AstrMessageEvent, CommandResult
from util.plugin_dev.api.v1.config import *
from util.plugin_dev.api.v1.platform import *

class HelloWorldPlugin:
    def __init__(self, context: Context) -> None:
        self.context = context
        self.context.register_task(self.send_msg_per_minute(), "send_msg_per_minute") # æ³¨å†Œä»»åŠ¡
    
    async def send_msg_per_minute(self):
        while True:
            await asyncio.sleep(5)
            for platform in self.context.platforms: # éå†æ‰€æœ‰å¹³å°
                if platform.platform_name == 'aiocqhttp': # aiocqhttp
                    inst = platform.platform_instance # è·å–å¹³å°å®ä¾‹
                    await inst.send_msg({"user_id": 905617992}, CommandResult().message("ä½ å¥½")) # å‘é€æ¶ˆæ¯ç»™qqå·ä¸º905617992çš„ç”¨æˆ·
        
```
ä¸Šé¢çš„ä¾‹å­ä½¿ç”¨äº†å¼‚æ­¥çš„æ–¹å¼æ¥å®ç°å®šæ—¶ä»»åŠ¡ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ threading.Thread æ¥å®ç°ã€‚

### æ³¨å†ŒæŒ‡ä»¤ context.register_commands()

ç”¨æˆ·å¯ä»¥é€šè¿‡è¾“å…¥æŒ‡ä»¤æ¥è°ƒç”¨æ’ä»¶çš„åŠŸèƒ½ã€‚

ä½¿ç”¨ context.register_commands æ³¨å†ŒæŒ‡ä»¤ã€‚æ¥æ”¶å¦‚ä¸‹å‚æ•°ï¼š

- plugin_name: str æ’ä»¶åã€‚ä¸ metadata.yaml ä¸­çš„ name ä¸€è‡´ã€‚
- command_name: str æŒ‡ä»¤åã€‚
- description: str æŒ‡ä»¤ç®€çŸ­æè¿°ã€‚
- priority: int ä¼˜å…ˆçº§ã€‚æ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚
- handler: callable æŒ‡ä»¤å¤„ç†å‡½æ•°ã€‚
- use_regex: bool æ˜¯å¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¯†åˆ«æŒ‡ä»¤ã€‚é»˜è®¤ä¸º Falseã€‚
- ignore_prefix: bool æ˜¯å¦å¿½ç•¥æŒ‡ä»¤å‰ç¼€ã€‚é»˜è®¤ä¸º Falseã€‚

å½“ç”¨æˆ·è¾“å…¥ä»¥ `command_name` å¼€å¤´çš„æŒ‡ä»¤æ—¶ï¼Œä¼šè°ƒç”¨ `handler` å‡½æ•°ã€‚

```py

from util.plugin_dev.api.v1.bot import CommandResult

def __init__(self, context: Context) -> None:
    self.context = context
    # æ’ä»¶åã€æŒ‡ä»¤åã€æè¿°ã€ä¼˜å…ˆçº§ã€å¤„ç†å‡½æ•°
    self.context.register_commands("helloworld", "helloworld", "å†…ç½®æµ‹è¯•æŒ‡ä»¤ã€‚", 1, self.helloworld)

def helloworld(self, message: AstrMessageEvent, context: Context):
    return CommandResult().message("Hello, World!")

æŒ‡ä»¤çš„ handler çš„è¿”å›å€¼åº”ä¸ºä¸€ä¸ª CommandResult å¯¹è±¡ã€‚æœ‰å…³å…·ä½“ä½¿ç”¨ï¼Œè¯·çœ‹ä¸‹èŠ‚ã€‚

```

åœ¨ v3.3.7 ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œæ”¯æŒé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ¥è¯†åˆ«æŒ‡ä»¤ã€‚

```py
# ä»¥ world ç»“å°¾çš„æ¶ˆæ¯éƒ½ä¼šè¢«è¯†åˆ«ä¸ºæŒ‡ä»¤
self.context.register_commands("helloworld", "world$", "å†…ç½®æµ‹è¯•æŒ‡ä»¤ã€‚", 1, self.helloworld, use_regex=True)
```

åœ¨ v3.3.8 ç‰ˆæœ¬ä¹‹åï¼Œæ”¯æŒå¿½ç•¥æŒ‡ä»¤å‰ç¼€ã€‚

```py
# å¿½ç•¥æŒ‡ä»¤å‰ç¼€
self.context.register_commands("helloworld", "haha", "å†…ç½®æµ‹è¯•æŒ‡ä»¤ã€‚", 1, self.helloworld, ignore_prefix=True)
```
> æŒ‡ä»¤å‰ç¼€æŒ‡çš„ä¸æ˜¯ç¬¬äºŒä¸ªå‚æ•°ï¼Œè€Œæ˜¯ç±»ä¼¼äº `/` è¿™æ ·çš„ç”¨æˆ·è®¾ç½®çš„æŒ‡ä»¤å‰ç¼€ã€‚ï¼ˆwakeæŒ‡ä»¤ï¼‰

å¿½ç•¥æŒ‡ä»¤å‰ç¼€åï¼Œç”¨æˆ·å‘é€çš„æ¶ˆæ¯ä¸­å¦‚æœä¸åŒ…å«æŒ‡ä»¤å‰ç¼€ï¼Œä¹Ÿä¼šè¢«è§¦å‘æŒ‡ä»¤ã€‚

### æ³¨å†Œ LLM Tools

LLM Tools è®©æ¨¡å‹èƒ½å¤Ÿè°ƒç”¨å¤–éƒ¨å·¥å…·ï¼Œæ¥å¢å¼ºè‡ªèº«èƒ½åŠ›ã€‚å€Ÿæ­¤ï¼Œä½ å¯ä»¥å®ç°ç”±ç”¨æˆ·è‡ªç„¶è¯­è¨€è¾“å…¥è§¦å‘ä½ çš„æ’ä»¶åŠŸèƒ½ã€‚

åœ¨ v3.3.11 ç‰ˆæœ¬åŠä¹‹åï¼Œæ”¯æŒæ³¨å†Œ LLM Toolsã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªæŸ¥è¯¢å¤©æ°”çš„ä¾‹å­ï¼š

```py
from util.plugin_dev.api.v1.bot import Context, AstrMessageEvent, CommandResult
from util.plugin_dev.api.v1.config import *

class ExamplePlugin:
    def __init__(self, context: Context) -> None:
        self.context = context
        self.context.register_llm_tool("get_weather", [{
            "type": "string", # å‚æ•°çš„ç±»å‹ã€‚æ”¯æŒçš„ç±»å‹è¯·å‰å¾€ OpenAI Function-Calling API æŸ¥çœ‹
            "name": "location", # å‚æ•°å
            "description": "åŸå¸‚åæˆ–å¿å" # å‚æ•°æè¿°
        }], "è·å–ä¸€ä¸ªåœ°åŒºçš„å¤©æ°”ï¼Œç”¨æˆ·åº”è¯¥æä¾›ä¸€ä¸ªåŸå¸‚åæˆ–å¿åã€‚", # å·¥å…·æè¿°
        self.query_weather) # å·¥å…·å‡½æ•°

    async def query_weather(self, location: str) -> CommandResult: # å·¥å…·å‡½æ•°ï¼Œå‚æ•°ååº”ä¸æ³¨å†Œæ—¶çš„å‚æ•°åä¸€è‡´
        # æŸ¥è¯¢å¤©æ°”
        weather = await query_weather(location) # ä½ çš„æŸ¥è¯¢å¤©æ°”å‡½æ•°
        return CommandResult().message(f"{location} çš„å¤©æ°”æ˜¯ {weather}ï¼")
```

æ¿€æ´»æ’ä»¶åï¼Œä¸€æ—¦ç”¨æˆ·è¾“å…¥äº† `è·å–åŒ—äº¬çš„å¤©æ°”` è¿™æ ·çš„æ¶ˆæ¯ï¼Œå¤§è¯­è¨€æ¨¡å‹å°±ä¼šè°ƒç”¨è¿™ä¸ªæ’ä»¶æä¾›çš„ `query_weather` å‡½æ•°ï¼Œå¹¶è¿”å›ç»“æœã€‚

å·¥å…·å‡½æ•°åº”å½“æ˜¯ä¸€ä¸ª`å¼‚æ­¥å‡½æ•°`ï¼Œè¿”å›å€¼åº”ä¸ºä¸€ä¸ª CommandResult å¯¹è±¡ã€‚å·¥å…·å‡½æ•°çš„å‚æ•°æ”¯æŒä¼ å…¥ `ame: AstrMessageEvent, context: Context`ï¼Œä»¥æ–¹ä¾¿è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

```py
    async def query_weather(self, ame: AstrMessageEvent, context: Context, location: str) -> CommandResult: # å·¥å…·å‡½æ•°ï¼Œå‚æ•°ååº”ä¸æ³¨å†Œæ—¶çš„å‚æ•°åä¸€è‡´
        message_str = ame.message_str # è·å–ç”¨æˆ·å‘é€çš„æ¶ˆæ¯å­—ç¬¦ä¸²
        # æŸ¥è¯¢å¤©æ°”
        weather = await query_weather(location) # ä½ çš„æŸ¥è¯¢å¤©æ°”å‡½æ•°
        return CommandResult().message(f"{location} çš„å¤©æ°”æ˜¯ {weather}ï¼")
```


## æŒ‡ä»¤è¿”å›å€¼ CommandResult

CommandResult æ˜¯æ’ä»¶æŒ‡ä»¤å¤„ç†å‡½æ•°çš„è¿”å›å€¼ã€‚

å¿«æ·è°ƒç”¨ï¼š

```py
CommandResult().message("Hello, World!") # è¿”å›ä¸€ä¸ªçº¯æ–‡æœ¬æ¶ˆæ¯
CommandResult().error("Hello, World!") # è¿”å›ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯
CommandResult().url_image("https://xxxxx") # é€šè¿‡ url è¿”å›ä¸€ä¸ªå›¾ç‰‡æ¶ˆæ¯
CommandResult().file_image("path/to/xxx.jpg") # é€šè¿‡æ–‡ä»¶è·¯å¾„è¿”å›ä¸€ä¸ªå›¾ç‰‡æ¶ˆæ¯
```

å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå·±æ„é€  CommandResult å¯¹è±¡ã€‚

```py
from util.plugin_dev.api.v1.types import Image, Plain

cmd_result = CommandResult(
    message_chain=[Plain("Hello, World!"), Image.fromURL("https://xxxxx")], # æ¶ˆæ¯é“¾
)
```

### å…³é—­æˆ–å¼€å¯æ–‡è½¬å›¾

é»˜è®¤æƒ…å†µä¸‹ï¼ŒCommandResult() æ˜¯å¦æ–‡è½¬å›¾å–å†³äºç”¨æˆ· t2i æŒ‡ä»¤çš„è®¾ç½®ã€‚ä½ å¯ä»¥é€šè¿‡ use_t2i æ–¹æ³•æ¥å¼ºè¡Œåœ¨è¿™ä¸ªå›å¤ä¸­å…³é—­æˆ–å¼€å¯æ–‡è½¬å›¾ã€‚

```py
CommandResult().message("Hello, World!").use_t2i(False) # å…³é—­æ–‡è½¬å›¾
```

:::tip
AstrBot è§¦å‘æ–‡è½¬å›¾åªä¼šåœ¨å›å¤æ“ä½œï¼ˆä¹Ÿå°±æ˜¯æŒ‡ä»¤å¤„ç†å‡½æ•°çš„returnï¼‰ä¸­ç”Ÿæ•ˆï¼Œå¦‚æœä½ åœ¨æ’ä»¶ä¸­ä¸»åŠ¨å‘é€æ¶ˆæ¯ï¼Œæ–‡è½¬å›¾æ°¸è¿œä¸ä¼šç”Ÿæ•ˆã€‚
:::

## AstrMessageEvent

æ’ä»¶å¤„ç†å‡½æ•°çš„å‚æ•°ä¹‹ä¸€ã€‚

å½“ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼ŒAstrBot ä¼šå°è£…å¥½æ¶ˆæ¯ï¼Œå½¢æˆ AstrMessageEvent å¯¹è±¡ï¼Œä¼ é€’ç»™æ’ä»¶ã€‚

- context: Context ä¸€äº›å…¬ç”¨æ•°æ®
- message_str: str çº¯æ¶ˆæ¯å­—ç¬¦ä¸²
- message_obj: AstrBotMessage æ¶ˆæ¯å¯¹è±¡
- platform: RegisteredPlatform æ¥æºå¹³å°
- role: str åŸºæœ¬èº«ä»½ã€‚`admin` æˆ– `member`
- session_id: int ä¼šè¯ id

### AstrBotMessage

è¿™æ˜¯æœºå™¨äººå†…éƒ¨çš„æ¶ˆæ¯å¯¹è±¡ï¼ˆv3.1.10 åï¼‰ï¼Œä¼šå¯¹æ¯ä¸ªå¹³å°åŸæœ¬çš„æ¶ˆæ¯ç±»è¿›è¡Œè½¬è¯‘ã€‚åŸå¹³å°çš„æ¶ˆæ¯ç±»åœ¨ `raw_message` ä¸­ã€‚

```py
tag: str # æ¶ˆæ¯æ¥æºæ ‡ç­¾
type: MessageType # æ¶ˆæ¯ç±»å‹ï¼ŒGROUP_MESSAGEã€FRIEND_MESSAGEã€GUILD_MESSAGE
self_id: str # æœºå™¨äººçš„è¯†åˆ«id
session_id: str # ä¼šè¯id
message_id: str # æ¶ˆæ¯id
sender: MessageMember # å‘é€è€…ï¼Œuser_id å’Œ nickname
message: List[BaseMessageComponent] # æ¶ˆæ¯é“¾ä½¿ç”¨ Nakuru çš„æ¶ˆæ¯é“¾æ ¼å¼
message_str: str # æœ€ç›´è§‚çš„çº¯æ–‡æœ¬æ¶ˆæ¯å­—ç¬¦ä¸²
raw_message: object åŸå¹³å°çš„æ¶ˆæ¯ç±»
timestamp: int # æ¶ˆæ¯æ—¶é—´æˆ³
```

## ä¸»åŠ¨å‘é€æ¶ˆæ¯

### å¿«æ·ä¸»åŠ¨å›å¤

> æ­¤åŠŸèƒ½ä¸æ”¯æŒ qqchan å¹³å°ï¼Œä¹Ÿå°±æ˜¯å®˜æ–¹æœºå™¨äººAPI ã€‚

AstrBot å°è£…äº†ä¸€ä¸ªç»Ÿä¸€çš„å¿«æ·å›å¤æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥åœ¨æ’ä»¶ä¸­è°ƒç”¨ã€‚ï¼ˆ>=v3.3.8ï¼‰

`unified_msg_origin`: è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨äºæ ‡è¯†æ¶ˆæ¯æ¥æºã€‚å®ƒçš„æ ¼å¼ç±»ä¼¼ `aiocqhttp:GroupMessage:123456`ã€‚å…¶ä¸­ `aiocqhttp` æ˜¯å¹³å°åï¼Œ`GroupMessage` æ˜¯æ¶ˆæ¯ç±»å‹ï¼Œ`123456` æ˜¯ç¾¤å·ã€‚

é€šè¿‡ä¿å­˜(å› ä¸ºæ˜¯å­—ç¬¦ä¸²ï¼Œå› æ­¤ä¹Ÿå¯ä»¥æŒä¹…åŒ–ä¿å­˜)è¿™ä¸ªæ ‡è¯†ï¼Œå¯ä»¥åœ¨åç»­çš„æ¶ˆæ¯ï¼ˆç”šè‡³é‡å¯ä¹‹åï¼‰ï¼Œé€šè¿‡æŒ‡å®šæ ‡è¯†æ¥ä¸»åŠ¨å‘é€æ¶ˆæ¯ç»™å¯¹åº”çš„æ¶ˆæ¯æ¥æºã€‚

æ­¤å€¼åœ¨ `AstrMessageEvent` ä¸­å¯ä»¥æ‰¾åˆ°ã€‚

```py
context.register_commands("sub", "sub", "å†…ç½®æµ‹è¯•æŒ‡ä»¤ã€‚", 1, self.sub)

def sub(self, message: AstrMessageEvent, context: Context):
    unified_msg_origin = message.unified_msg_origin
    # ä¿å­˜æ­¤å€¼ ...

def send(self, context: Context):
    # é€šè¿‡ unified_msg_origin å›å¤æ¶ˆæ¯
    await context.send_message(unified_msg_origin, CommandResult().message("Hello, World!"))
```

æœ‰äº†è¿™ä¸ªåŠŸèƒ½ï¼Œä½ å¯ä»¥å®ç°ä¸€äº›å¤æ‚çš„æ’ä»¶é€»è¾‘ï¼Œæ¯”å¦‚è®¢é˜…ã€å®šæ—¶ä»»åŠ¡ç­‰ã€‚

### ä¸»åŠ¨å‘é€æ¶ˆæ¯çš„å…¶ä»–æ–¹æ³•

æ’ä»¶å¯ä»¥ä¸»åŠ¨ç»™å—æ”¯æŒçš„å¹³å°å‘é€æ¶ˆæ¯ã€‚(>=v3.3.3)

é‡‡ç”¨ context.platforms è·å–æ‰€æœ‰å·²æ³¨å†Œ(å¯ç”¨)çš„å¹³å°ã€‚

```py
platforms = context.platforms
```

`platfroms` ä¸ºä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª RegisteredPlatform å¯¹è±¡ã€‚RegisteredPlatform å¯¹è±¡åŒ…å«ä»¥ä¸‹å±æ€§ï¼š

- platform_name: str
- platform_instance: Platform
- origin: str = None  # æ³¨å†Œæ¥æº

å½“å‰ AstrBot å†…éƒ¨æ”¯æŒçš„å¹³å°çš„ platform_name æœ‰ï¼š

- aiocqhttp
- qqchan
- nakuru

å…¶ä¸­ï¼Œaiocqhttp çš„ç¨³å®šæ€§æœ€é«˜ï¼Œqqchan å’Œ nakuru ä¸ºå®éªŒæ€§æ”¯æŒã€‚

ç„¶åé€šè¿‡å¹³å°å®ä¾‹ `platform_instance` çš„ send_msg æ–¹æ³•å‘é€æ¶ˆæ¯ã€‚send_msg æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š`target` å’Œ `message`ã€‚`target` ä¸ºç›®æ ‡ï¼Œ`message` ä¸º `CommandResult` å¯¹è±¡ã€‚

### aiocqhttp

`target` æ¥æ”¶ä¸€ä¸ª dict ç±»å‹çš„å€¼å¼•ç”¨ã€‚

- è¦å‘ç»™ QQ ä¸‹çš„æŸä¸ªç”¨æˆ·ï¼Œè¯·æ·»åŠ  key `user_id`ï¼Œå€¼ä¸º int ç±»å‹çš„ qq å·ï¼›
- è¦å‘ç»™æŸä¸ªç¾¤èŠï¼Œè¯·æ·»åŠ  key `group_id`ï¼Œå€¼ä¸º int ç±»å‹çš„ qq ç¾¤å·ï¼›

### nakuru

`target` æ¥æ”¶ä¸€ä¸ª dict ç±»å‹çš„å€¼å¼•ç”¨ã€‚

- è¦å‘ç»™ QQ ä¸‹çš„æŸä¸ªç”¨æˆ·ï¼Œè¯·æ·»åŠ  key `user_id`ï¼Œå€¼ä¸º int ç±»å‹çš„ qq å·ï¼›
- è¦å‘ç»™æŸä¸ªç¾¤èŠï¼Œè¯·æ·»åŠ  key `group_id`ï¼Œå€¼ä¸º int ç±»å‹çš„ qq ç¾¤å·ï¼›
- è¦å‘ç»™æŸä¸ªé¢‘é“ï¼Œè¯·æ·»åŠ  key `guild_id`, `channel_id`ã€‚å‡ä¸º int ç±»å‹ã€‚

guild_id ä¸æ˜¯é¢‘é“å·ã€‚


### qqchan

`target` æ¥æ”¶ä¸€ä¸ª dict ç±»å‹çš„å€¼å¼•ç”¨ã€‚

- å¦‚æœç›®æ ‡æ˜¯ QQ ç¾¤ï¼Œè¯·æ·»åŠ  key `group_openid`ã€‚
- å¦‚æœç›®æ ‡æ˜¯ é¢‘é“æ¶ˆæ¯ï¼Œè¯·æ·»åŠ  key `channel_id`ã€‚
- å¦‚æœç›®æ ‡æ˜¯ é¢‘é“ç§èŠï¼Œè¯·æ·»åŠ  key `guild_id`ã€‚


ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š

```py
import threading 
from util.plugin_dev.api.v1.bot import Context, AstrMessageEvent, CommandResult
from util.plugin_dev.api.v1.config import *

class HelloWorldPlugin:
    """
    AstrBot ä¼šä¼ é€’ context ç»™æ’ä»¶ã€‚
    
    - context.register_commands: æ³¨å†ŒæŒ‡ä»¤
    - context.register_task: æ³¨å†Œä»»åŠ¡
    - context.message_handler: æ¶ˆæ¯å¤„ç†å™¨(å¹³å°ç±»æ’ä»¶ç”¨)
    """
    def __init__(self, context: Context) -> None:
        self.context = context
        self.context.register_commands("helloworld", "helloworld", "å†…ç½®æµ‹è¯•æŒ‡ä»¤ã€‚", 1, self.helloworld)

    async def helloworld(self, message: AstrMessageEvent, context: Context):
        await self.send_msg()

    async def send_msg(self):
        platforms = self.context.platforms
        platform = None
        for p in platforms:
            if p.platform_name == 'aiocqhttp':
                platform = p
                break
        if platform:
            inst = message.platform.platform_instance
            await inst.send_msg({"user_id": 123456}, CommandResult().message("Hello, World!"))
```


ğŸš§ æ–½å·¥ä¸­ ğŸš§
