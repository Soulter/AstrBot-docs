:::info

æ¬¢è¿åŠ ç¾¤ 322154837 è®¨è®ºã€‚

:::

# å¦‚ä½•å¼€å‘

## ä½¿ç”¨æ¨¡æ¿å¼€å‘

ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œæœ¬é¡¹ç›®çš„æ’ä»¶ä¸€å¾‹è¾“å‡ºä¸º Git ä»“åº“ã€‚

é¦–å…ˆæ‰“å¼€ [helloworld](https://github.com/Soulter/helloworld)ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªæ’ä»¶æ¨¡æ¿ï¼Œæ¥ä¸‹æ¥åœ¨è¿™ä¸ªæ¨¡æ¿ä¸ŠäºŒæ¬¡å¼€å‘ã€‚

æ¥ä¸‹æ¥ç‚¹å‡»å³ä¸Šè§’çš„ Use this templateï¼Œç„¶åç‚¹å‡» Create new repositoryã€‚
![image](https://github.com/Soulter/AstrBot-docs/assets/37870767/7891edd8-3968-4cb8-aae3-b29b92aa1770)

ç„¶ååœ¨ Repository name å¤„è¾“å…¥ä½ çš„æ’ä»¶åå­—ï¼Œä¸è¦ä¸­æ–‡ã€‚å»ºè®®ä»¥ `astrbot_plugin_` å¼€å¤´ï¼Œå¦‚ `astrbot_plugin_yuanshen`ã€‚
![image](https://github.com/Soulter/AstrBot-docs/assets/37870767/560fa66f-740a-456c-a6dc-3766a79d3e9f)

åˆ›å»ºå¥½åï¼Œæ‰“å¼€ç”µè„‘ä¸Šçš„ Visual Studio Codeï¼Œç„¶åå°†åˆ›å»ºå¥½çš„ä»“åº“ clone ä¸‹æ¥ã€‚æœ‰å…³æ€ä¹ˆ cloneï¼Œè¯·è‡ªè¡Œå‚è€ƒç½‘ä¸Šã€‚

:::caution
å¼ºçƒˆå»ºè®®æŠŠæ¨¡æ¿ä»“åº“ fork ä¹‹å clone åˆ°æœºå™¨äººæ–‡ä»¶å¤¹ä¸‹çš„ addons/plugins/ ç›®å½•ä¸‹ï¼Œç„¶åç”¨ Pycharm/VSCode ç­‰å·¥å…·æ‰“å¼€å¯è·æ›´æ£’çš„ç¼–ç¨‹ä½“éªŒï¼ˆè‡ªåŠ¨è¡¥å…¨ç­‰ï¼‰ã€‚å»ºè®®æ‰€æœ‰å¼€å‘è€…éƒ½è¿™æ ·åšï¼Œä¸ç„¶å¾ˆéš¾äº†è§£åˆ°ä¸€äº›æ•°æ®ç»“æ„ã€‚
:::

æ¥ä¸‹æ¥æ‰“å¼€ main.pyï¼Œä½ å°±å¯ä»¥åœ¨è¿™é‡Œé¢åˆ›å»ºå±äºä½ çš„æ’ä»¶äº†ï¼ï¼ï¼


# æ’ä»¶æ ¼å¼

> è¿™é‡Œæˆ‘å†å¨å¨ä¸€ä¸‹æ’ä»¶çš„æ ¼å¼è§„èŒƒã€‚

- ä»“åº“åï¼šä»»æ„
- å¿…é¡»å«æœ‰ `main.py` æ–‡ä»¶ï¼Œä¸” `main.py` ä¸­éœ€è¦å«æœ‰ä¸€ä¸ªç‰¹å®šçš„ç±»ï¼ˆä¸‹ç§°â€œä¸»ç±»â€ï¼‰
- ä¸»ç±»çš„è¦æ±‚ï¼š`æ’ä»¶å`+`Plugin` æ ¼å¼æˆ–è€… `Main`ï¼Œå¦åˆ™æœºå™¨äººç¨‹åºå°†è¯†åˆ«ä¸åˆ°ã€‚å¦‚"HelloWorldPlugin"ã€‚ä¸åŒºåˆ†å¤§å°å†™ã€‚
- ä¸»ç±»ä¸­å¿…é¡»å®ç°ä¸¤ä¸ªå‡½æ•° `run(ame: AstrMessageEvent)` å’Œ `info()`ï¼Œä¸”è¿”å›å€¼æ»¡è¶³è§„èŒƒã€‚**æ¨èåœ¨ https://github.com/Soulter/helloworld è¿™ä¸ªæ¨¡æ¿ä»“åº“ä¹‹ä¸Šè¿›è¡Œå¼€å‘ã€‚**
- æ’ä»¶çš„ä»‹ç»è¯·å†™åœ¨ `README.md` ä¸­ã€‚
- æŒ‡ä»¤çš„ä¾èµ–åº“è¯·å†™åœ¨ `requirements.txt` ä¸­

> infoå‡½æ•°é‡Œçš„æ’ä»¶åæ˜¯æ‚¨çš„æ’ä»¶çš„**å”¯ä¸€è¯†åˆ«å**ã€‚

# å¼€å‘åçš„æ’ä»¶å¦‚ä½•ä½¿ç”¨ï¼Ÿ
- é¦–å…ˆéœ€è¦å°†ä»“åº“ä¸Šä¼ åˆ° Github æˆ–è€… Giteeã€‚æœ‰å…³æ€ä¹ˆä¸Šä¼ ï¼Œè¯·è‡ªè¡Œå»ç½‘ä¸Šæœç´¢ã€‚
- ä¸Šä¼ å¥½åä½¿ç”¨æŒ‡ä»¤ `plugin i ä»“åº“åœ°å€` è¿›è¡Œå¯¼å…¥ã€‚å¦‚ `plugin i https://github.com/Soulter/helloworld`
- å¼€å‘å¥½çš„æ’ä»¶å¯ä»¥é€šè¿‡ issue æäº¤è‡³æ­¤é¡¹ç›®ï¼Œæˆ‘ä»¬ä¼šå°†å…¶æ”¾è‡³ç›¸åº”ä½ç½®ä¾›ç”¨æˆ·å®‰è£…ã€‚

# AstrBot API
ç›®å‰ï¼Œå¼€æ”¾çš„ API éƒ½æ”¾åœ¨äº† `util.plugin_dev.api.v1` åŒ…ä¸‹ï¼Œå»ºè®®å¼€å‘è€…å‰å¾€æŸ¥é˜…å…¶å†…éƒ¨çš„æ³¨é‡Šæ¥æ›´å¥½åœ°äº†è§£æ’ä»¶å¼€å‘ã€‚

```
util.plugin_dev.api.v1
|- bot.py
|- config.py é…ç½®å¤„ç†ã€‚æ’ä»¶å¼€å‘è€…å¯ä»¥è°ƒç”¨å…¶å†…éƒ¨çš„å‡½æ•°æ¥æ–¹ä¾¿åœ°å­˜å‚¨æ•°æ®ã€é…ç½®ä¿¡æ¯ã€‚
|- llm.py
|- message.py # æ¶ˆæ¯ã€‚å…¶ä¸­çš„ oper_msg å‡½æ•°ç”¨äºæ¶ˆæ¯å¹³å°ç±»çš„æ’ä»¶æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œè°ƒç”¨æ­¤å‡½æ•°è¿›è¡Œå¤„ç†ã€‚è¿™ä¸ªå‡½æ•°é›†æˆäº†æŒ‡ä»¤æ£€æµ‹ã€æŒ‡ä»¤å¤„ç†ã€æ’ä»¶è°ƒç”¨ã€LLM è°ƒç”¨ç­‰åŠŸèƒ½ã€‚æ­¤å¤–è¿˜æœ‰
|- register.py # å…è®¸å¼€å‘è€…æ³¨å†ŒæŸä¸€ä¸ªç±»çš„å®ä¾‹åˆ° LLM æˆ–è€… PLATFORM ä¸­ï¼Œæ–¹ä¾¿å…¶ä»–æ’ä»¶è°ƒç”¨ã€‚å¿…é¡»åˆ†åˆ«å®ç° Platform å’Œ LLMProvider ä¸­æ¶‰åŠçš„æ¥å£
|- platform.py # æ¶ˆæ¯å¹³å°ã€‚å«æœ‰ Platform ç±»ä»¥åŠ AstrBot è‡ªå¸¦çš„æ¶ˆæ¯å¹³å° QQGOCQ ç±»å’Œ QQOfficial ç±»ã€‚
|- types.py # æ’ä»¶ç±»å‹ã€‚åœ¨è¡¥å…… info å‡½æ•°çš„æ—¶å€™å¯ä»¥ç”¨åˆ°
```

# æ•°æ®ç»“æ„å®šä¹‰

:::caution

å¦‚æœçœ‹å®Œä¹‹åè¿˜æ˜¯çœ‹ä¸æ‡‚ï¼Œè¯·çœ‹ä¸‹é¢çš„ `å¦‚ä½•å¾—åˆ°/å‘é€æ¶ˆæ¯`

:::

## AstrMessageEvent ç±»

run å‡½æ•°ä¸­çš„å‚æ•° ame çš„ç±»å‹æ˜¯ AstrMessageEventï¼Œå…¶å†…å®¹æ˜¯ï¼š
```py

context: GlobalObject # ä¸€äº›å…¬ç”¨æ•°æ®
message_str: str # çº¯æ¶ˆæ¯å­—ç¬¦ä¸²
message_obj: AstrBotMessage # æ¶ˆæ¯å¯¹è±¡
platform: RegisteredPlatform # æ¥æºå¹³å°
role: str # åŸºæœ¬èº«ä»½ã€‚`admin` æˆ– `member`
session_id: int # ä¼šè¯ id
```

## AstrBotMessage ç±»

è¿™æ˜¯æœºå™¨äººå†…éƒ¨çš„æ¶ˆæ¯å¯¹è±¡ï¼ˆv3.1.10 åï¼‰ï¼Œä¼šå¯¹æ¯ä¸ªå¹³å°åŸæœ¬çš„æ¶ˆæ¯ç±»è¿›è¡Œè½¬è¯‘ã€‚åŸå¹³å°çš„æ¶ˆæ¯ç±»åœ¨ `raw_message` ä¸­ã€‚

```py
tag: str # æ¶ˆæ¯æ¥æºæ ‡ç­¾
type: MessageType # æ¶ˆæ¯ç±»å‹
self_id: str # æœºå™¨äººçš„è¯†åˆ«id
session_id: str # ä¼šè¯id
message_id: str # æ¶ˆæ¯id
sender: MessageMember # å‘é€è€…
message: List[BaseMessageComponent] # æ¶ˆæ¯é“¾ä½¿ç”¨ Nakuru çš„æ¶ˆæ¯é“¾æ ¼å¼
message_str: str # æœ€ç›´è§‚çš„çº¯æ–‡æœ¬æ¶ˆæ¯å­—ç¬¦ä¸²
raw_message: object åŸå¹³å°
timestamp: int # æ¶ˆæ¯æ—¶é—´æˆ³
```

### MessageType
æ¶ˆæ¯ç±»å‹

```py
class MessageType(Enum):
    GROUP_MESSAGE = 'GroupMessage' # ç¾¤ç»„å½¢å¼çš„æ¶ˆæ¯
    FRIEND_MESSAGE = 'FriendMessage' # ç§èŠã€å¥½å‹ç­‰å•èŠæ¶ˆæ¯
    GUILD_MESSAGE = 'GuildMessage' # é¢‘é“æ¶ˆæ¯
```

### MessageMember
æ¶ˆæ¯å‘é€äººçš„åŸºæœ¬ä¿¡æ¯

```
@dataclass
class MessageMember():
    user_id: str # å‘é€è€…id
    nickname: str = None
```


:::caution

å½“ `tag` == `gocq` æ—¶ï¼ŒAstrBotMessage ä¸­çš„ `raw_message` çš„å†…å®¹æ˜¯ Nakuru å†…çš„æ¶ˆæ¯ç±»ã€‚

å½“ `tag` == `qqchan` æ—¶ï¼ŒAstrBotMessage ä¸­çš„ `raw_message` çš„å†…å®¹æ˜¯ QQ æœºå™¨äºº SDK ä¸­çš„ Message ç±»ã€‚

:::

## RegisteredPlatform ç±»
è¿™æ˜¯æœºå™¨äººå†…æ³¨å†Œçš„æ¶ˆæ¯å¹³å°ã€‚
```py
@dataclass
class RegisteredPlatform:
    '''
    æ³¨å†Œåœ¨ AstrBot ä¸­çš„å¹³å°ã€‚å¹³å°åº”å½“å®ç° Platform æ¥å£ã€‚
    '''
    platform_name: str
    platform_instance: Platform
    origin: str = None # æ³¨å†Œæ¥æº
```

ç±»ä¼¼çš„ï¼Œè¿˜æœ‰ RegisteredLLM ç±»ï¼Œæ˜¯æœºå™¨äººå†…æ³¨å†Œçš„å¤§è¯­è¨€æ¨¡å‹ã€‚

å¦‚æœæ’ä»¶æ˜¯æ¶ˆæ¯å¹³å°æ€§è´¨çš„æˆ–è€…LLMæ€§è´¨çš„ï¼ˆæ¯”å¦‚è¯´æˆ‘è¦å†™ä¸€ä¸ªæ’ä»¶æ¥æ¥æ”¶ KOOK ä¸Šçš„æ¶ˆæ¯ï¼Œæˆ–è€…æˆ‘è¦å†™ä¸€ä¸ªæ’ä»¶æ¥æ¥å…¥æ–‡æ–°ä¸€è¨€ï¼‰ï¼Œå¯ä»¥é€šè¿‡ï¼š
```py
from util.plugin_dev.api.v1.register import register_llm, unregister_llm, register_platform, unregister_platform
```
æ¥æ³¨å†Œæ¶ˆæ¯å¹³å°å’ŒLLMã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**å¿…é¡»å®ç°**ç›¸åº”çš„
```
from util.plugin_dev.api.v1.llm import LLMProvider # ç±»
from util.plugin_dev.api.v1.platform import Platform # ç±»
```
ä¸­çš„æ–¹æ³•ã€‚


# å¦‚ä½•å¾—åˆ°/å‘é€æ¶ˆæ¯ç­‰å†…å®¹

## å¾—åˆ°çº¯æ–‡æœ¬æ¶ˆæ¯

```py
text = ame.message_str
```

## å‘é€çº¯æ–‡æœ¬æ¶ˆæ¯

```py
text = "åŸç¥"
return CommandResult(
    hit=True,
    success=True,
    message_chain=[Plain(text)],
    command_name="helloworld"
)

# æˆ–è€…ï¼š
# return CommandResult(
#     hit=True,
#     success=True,
#     message_chain=text,
#     command_name="helloworld"
# )

```

## å¾—åˆ°æ¶ˆæ¯é“¾ï¼ˆæ¶ˆæ¯çš„æ‰€æœ‰å›¾æ–‡å†…å®¹ï¼‰

æ¶ˆæ¯é“¾å°±æ˜¯æŒ‰é¡ºåºå­˜å‚¨çš„ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ä¸­å†…å®¹çš„åˆ—è¡¨ï¼ˆå¯¹äºQQé¢‘é“ï¼Œä¸æ˜¯æŒ‰é¡ºåºçš„ï¼‰ã€‚
ç›®å‰ç¨³å®šæ”¯æŒçš„åˆ—è¡¨ä¸­çš„æ•°æ®ç±»å‹ï¼š

- Plainï¼šçº¯æ–‡æœ¬
- Imageï¼šå›¾ç‰‡

ä¸€ä¸ªä¾‹å­æ˜¯ï¼š
```
[Plain("ä½ çœ‹è¿™å¼ å›¾: "), Image("url: xxxxxx"), Plain("6ä¸ï¼Ÿ")]
```

å…¶ä¸­ï¼ŒImage çš„ç»“æ„ï¼š
```
class Image(BaseMessageComponent):
    type: ComponentType = "Image"
    file: T.Optional[str]
    _type: T.Optional[str]
    subType: T.Optional[int]
    url: T.Optional[str]
    cache: T.Optional[bool] = True
    id: T.Optional[int] = 40000
    c: T.Optional[int] = 2
```

```py
message_chain = ame.message_obj.message
text = ""
image_path = ""
for message_item in message_chain:
    if isinstance(message_item, Plain):
        text += message_item.text
    elif isinstance(message_item, Image):
        if message_item.path is not None:
            image_path = message_item.path
        else:
            image_path = message_item.file
```


## å‘é€æ¶ˆæ¯é“¾ï¼ˆæ¶ˆæ¯çš„æ‰€æœ‰å›¾æ–‡å†…å®¹ï¼‰

```py
text = "åŸç¥"
image_url = "https://xxxxx"
image_filepath = "path/to/xxx.jpg"
return CommandResult(
    hit=True,
    success=True,
    message_chain=[Plain(text), 
        Image.fromURL(image_url), 
        Image.fromFileSystem(image_filepath)],
    command_name="helloworld"
)

```

## ä¸»åŠ¨å‘é€æ¶ˆæ¯

ğŸš§ æ–½å·¥ä¸­ ğŸš§
