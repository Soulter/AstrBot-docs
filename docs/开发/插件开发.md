:::info

æ¬¢è¿åŠ ç¾¤ 322154837 è®¨è®ºã€‚

:::

## å¦‚ä½•å¼€å‘

- clone AstrBot é¡¹ç›®æœ¬ä½“åˆ°æœ¬åœ°ã€‚
- æ‰“å¼€ [helloworld](https://github.com/Soulter/helloworld)ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªæ’ä»¶æ¨¡æ¿ï¼Œæ¥ä¸‹æ¥åœ¨è¿™ä¸ªæ¨¡æ¿ä¸ŠäºŒæ¬¡å¼€å‘ã€‚
- ç‚¹å‡»å³ä¸Šè§’çš„ Use this templateï¼Œç„¶åç‚¹å‡» Create new repositoryã€‚
- åœ¨ Repository name å¤„è¾“å…¥ä½ çš„æ’ä»¶åå­—ï¼Œä¸è¦ä¸­æ–‡ã€‚å»ºè®®ä»¥ `astrbot_plugin_` å¼€å¤´ï¼Œå¦‚ `astrbot_plugin_yuanshen`ã€‚
  - ![image](https://github.com/Soulter/AstrBot-docs/assets/37870767/560fa66f-740a-456c-a6dc-3766a79d3e9f)
- clone åˆ›å»ºå¥½çš„ä»“åº“ã€‚ï¼ˆæœ‰å…³æ€ä¹ˆ cloneï¼Œè¯·è‡ªè¡Œå‚è€ƒå…¶ä»–ç½‘ç»œæ•™ç¨‹ï¼‰
- å°† clone å¥½çš„æ’ä»¶å·¥ç¨‹å¤åˆ¶åˆ° AstrBot çš„ addons/plugins/ ç›®å½•ä¸‹ã€‚
- ä½¿ç”¨ VSCodeã€PyCharm ç­‰ IDE æ‰“å¼€ AstrBot é¡¹ç›®ã€‚
- æ‰“å¼€ `addons/plugins/<ä½ çš„æ’ä»¶å>/metadata.yaml`ã€‚ä½ åº”è¯¥èƒ½çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š
    ```yaml
    name: helloworld # è¿™æ˜¯ä½ çš„æ’ä»¶çš„å”¯ä¸€è¯†åˆ«åã€‚
    desc: è¿™æ˜¯ AstrBot çš„é»˜è®¤æ’ä»¶ã€‚
    help: 
    version: v1.3 # æ’ä»¶ç‰ˆæœ¬å·ã€‚æ ¼å¼ï¼šv1.1.1 æˆ–è€… v1.1
    author: Soulter # ä½œè€…
    repo: https://github.com/Soulter/helloworld # æ’ä»¶çš„ä»“åº“åœ°å€
    ```

## å¼€å‘åçš„æ’ä»¶å¦‚ä½•ä½¿ç”¨ï¼Ÿ
- å¼€å‘å®Œæ¯•åï¼Œå°†æ’ä»¶æ¨é€è‡³ GitHubã€‚
- ä¸Šä¼ å¥½åä½¿ç”¨æŒ‡ä»¤ `plugin i ä»“åº“åœ°å€` è¿›è¡Œå¯¼å…¥ã€‚å¦‚ `plugin i https://github.com/Soulter/helloworld`
- å¼€å‘å¥½çš„æ’ä»¶å¯ä»¥é€šè¿‡ issue æäº¤è‡³æ­¤é¡¹ç›®ï¼Œæˆ‘ä»¬ä¼šå°†å…¶æ”¾è‡³ç›¸åº”ä½ç½®ä¾›ç”¨æˆ·å®‰è£…ã€‚


## æœ€å°å®ä¾‹

```py
from util.plugin_dev.api.v1.bot import Context, AstrMessageEvent, CommandResult
from util.plugin_dev.api.v1.config import *

class Main:
    """
    AstrBot ä¼šä¼ é€’ context ç»™æ’ä»¶ã€‚
    
    - context.register_commands: æ³¨å†ŒæŒ‡ä»¤
    - context.register_task: æ³¨å†Œä»»åŠ¡
    - context.message_handler: æ¶ˆæ¯å¤„ç†å™¨(å¹³å°ç±»æ’ä»¶ç”¨)
    """
    def __init__(self, context: Context) -> None:
        self.context = context
        self.context.register_commands("helloworld", "helloworld", "å†…ç½®æµ‹è¯•æŒ‡ä»¤ã€‚", 1, self.helloworld)

    """
    æŒ‡ä»¤å¤„ç†å‡½æ•°ã€‚
    
    - éœ€è¦æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šmessage: AstrMessageEvent, context: Context
    - è¿”å› CommandResult å¯¹è±¡
    """
    def helloworld(self, message: AstrMessageEvent, context: Context):
        return CommandResult().message("Hello, World!")
```

## æ³¨å†ŒæŒ‡ä»¤

ç”¨æˆ·å¯ä»¥é€šè¿‡è¾“å…¥æŒ‡ä»¤æ¥è°ƒç”¨æ’ä»¶çš„åŠŸèƒ½ã€‚

ä½¿ç”¨ context.register_commands æ³¨å†ŒæŒ‡ä»¤ã€‚æ¥æ”¶å¦‚ä¸‹å‚æ•°ï¼š

- plugin_name: str æ’ä»¶åã€‚ä¸ metadata.yaml ä¸­çš„ name ä¸€è‡´ã€‚
- command_name: str æŒ‡ä»¤åã€‚
- description: str æŒ‡ä»¤ç®€çŸ­æè¿°ã€‚
- priority: int ä¼˜å…ˆçº§ã€‚æ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚
- handler: callable æŒ‡ä»¤å¤„ç†å‡½æ•°ã€‚

å½“ç”¨æˆ·è¾“å…¥ä»¥ `command_name` å¼€å¤´çš„æŒ‡ä»¤æ—¶ï¼Œä¼šè°ƒç”¨ `handler` å‡½æ•°ã€‚

```py

from util.plugin_dev.api.v1.bot import CommandResult

def __init__(self, context: Context) -> None:
    self.context = context
    self.context.register_commands("helloworld", "helloworld", "å†…ç½®æµ‹è¯•æŒ‡ä»¤ã€‚", 1, self.helloworld)

def helloworld(self, message: AstrMessageEvent, context: Context):
    return CommandResult().message("Hello, World!")

æŒ‡ä»¤çš„ handler çš„è¿”å›å€¼åº”ä¸ºä¸€ä¸ª CommandResult å¯¹è±¡ã€‚æœ‰å…³å…·ä½“ä½¿ç”¨ï¼Œè¯·çœ‹ä¸‹èŠ‚ã€‚

```

## æŒ‡ä»¤è¿”å›å€¼ CommandResult

CommandResult æ˜¯æ’ä»¶æŒ‡ä»¤å¤„ç†å‡½æ•°çš„è¿”å›å€¼ã€‚

å¿«æ·è°ƒç”¨ï¼š

```py
CommandResult().message("Hello, World!") # è¿”å›ä¸€ä¸ªçº¯æ–‡æœ¬æ¶ˆæ¯
CommandResult().error("Hello, World!") # è¿”å›ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯
CommandResult().url_image("https://xxxxx") # é€šè¿‡ url è¿”å›ä¸€ä¸ªå›¾ç‰‡æ¶ˆæ¯
CommandResult().file_image("path/to/xxx.jpg") # é€šè¿‡æ–‡ä»¶è·¯å¾„è¿”å›ä¸€ä¸ªå›¾ç‰‡æ¶ˆæ¯
```

å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå·±æ„é€  CommandResult å¯¹è±¡ã€‚

```py
from util.plugin_dev.api.v1.types import Image, Plain

cmd_result = CommandResult(
    message_chain=[Plain("Hello, World!"), Image.fromURL("https://xxxxx")], # æ¶ˆæ¯é“¾
)
```

## ä¸»åŠ¨å‘é€æ¶ˆæ¯

æ’ä»¶å¯ä»¥ä¸»åŠ¨ç»™å—æ”¯æŒçš„å¹³å°å‘é€æ¶ˆæ¯ã€‚(>=v3.3.3)

é‡‡ç”¨ context.platforms è·å–æ‰€æœ‰å·²æ³¨å†Œ(å¯ç”¨)çš„å¹³å°ã€‚

```py
platforms = context.platforms
```

`platfroms` ä¸ºä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª RegisteredPlatform å¯¹è±¡ã€‚RegisteredPlatform å¯¹è±¡åŒ…å«ä»¥ä¸‹å±æ€§ï¼š

- platform_name: str
- platform_instance: Platform
- origin: str = None  # æ³¨å†Œæ¥æº

å½“å‰ AstrBot å†…éƒ¨æ”¯æŒçš„å¹³å°çš„ platform_name æœ‰ï¼š

- aiocqhttp
- qqchan
- nakuru

å…¶ä¸­ï¼Œaiocqhttp çš„ç¨³å®šæ€§æœ€é«˜ï¼Œqqchan å’Œ nakuru ä¸ºå®éªŒæ€§æ”¯æŒã€‚

ç„¶åé€šè¿‡å¹³å°å®ä¾‹ `platform_instance` çš„ send_msg æ–¹æ³•å‘é€æ¶ˆæ¯ã€‚send_msg æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š`target` å’Œ `message`ã€‚`target` ä¸ºç›®æ ‡ï¼Œ`message` ä¸º `CommandResult` å¯¹è±¡ã€‚

### aiocqhttp

`target` æ¥æ”¶ä¸€ä¸ª dict ç±»å‹çš„å€¼å¼•ç”¨ã€‚

- è¦å‘ç»™ QQ ä¸‹çš„æŸä¸ªç”¨æˆ·ï¼Œè¯·æ·»åŠ  key `user_id`ï¼Œå€¼ä¸º int ç±»å‹çš„ qq å·ï¼›
- è¦å‘ç»™æŸä¸ªç¾¤èŠï¼Œè¯·æ·»åŠ  key `group_id`ï¼Œå€¼ä¸º int ç±»å‹çš„ qq ç¾¤å·ï¼›

### nakuru

`target` æ¥æ”¶ä¸€ä¸ª dict ç±»å‹çš„å€¼å¼•ç”¨ã€‚

- è¦å‘ç»™ QQ ä¸‹çš„æŸä¸ªç”¨æˆ·ï¼Œè¯·æ·»åŠ  key `user_id`ï¼Œå€¼ä¸º int ç±»å‹çš„ qq å·ï¼›
- è¦å‘ç»™æŸä¸ªç¾¤èŠï¼Œè¯·æ·»åŠ  key `group_id`ï¼Œå€¼ä¸º int ç±»å‹çš„ qq ç¾¤å·ï¼›
- è¦å‘ç»™æŸä¸ªé¢‘é“ï¼Œè¯·æ·»åŠ  key `guild_id`, `channel_id`ã€‚å‡ä¸º int ç±»å‹ã€‚

guild_id ä¸æ˜¯é¢‘é“å·ã€‚


### qqchan

`target` æ¥æ”¶ä¸€ä¸ª dict ç±»å‹çš„å€¼å¼•ç”¨ã€‚

- å¦‚æœç›®æ ‡æ˜¯ QQ ç¾¤ï¼Œè¯·æ·»åŠ  key `group_openid`ã€‚
- å¦‚æœç›®æ ‡æ˜¯ é¢‘é“æ¶ˆæ¯ï¼Œè¯·æ·»åŠ  key `channel_id`ã€‚
- å¦‚æœç›®æ ‡æ˜¯ é¢‘é“ç§èŠï¼Œè¯·æ·»åŠ  key `guild_id`ã€‚


ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š

```py
import threading 
from util.plugin_dev.api.v1.bot import Context, AstrMessageEvent, CommandResult
from util.plugin_dev.api.v1.config import *

class HelloWorldPlugin:
    """
    AstrBot ä¼šä¼ é€’ context ç»™æ’ä»¶ã€‚
    
    - context.register_commands: æ³¨å†ŒæŒ‡ä»¤
    - context.register_task: æ³¨å†Œä»»åŠ¡
    - context.message_handler: æ¶ˆæ¯å¤„ç†å™¨(å¹³å°ç±»æ’ä»¶ç”¨)
    """
    def __init__(self, context: Context) -> None:
        self.context = context
        self.context.register_commands("helloworld", "helloworld", "å†…ç½®æµ‹è¯•æŒ‡ä»¤ã€‚", 1, self.helloworld)

    async def helloworld(self, message: AstrMessageEvent, context: Context):
        await self.send_msg()

    async def send_msg(self):
        platforms = self.context.platforms
        platfrom = None
        for p in platforms:
            if p.platform_name == 'aiocqhttp':
                platfrom = p
                break
        if platfrom:
            inst = message.platform.platform_instance
            await inst.send_msg({"user_id": 123456}, "Hello, World!")
```

ä¸€èˆ¬æ¥è¯´ï¼Œéœ€è¦ç”¨åˆ°ä¸»åŠ¨å‘é€æ¶ˆæ¯çš„åœºæ™¯ä¸€èˆ¬æ˜¯åå°é•¿ä»»åŠ¡ã€‚è¿™æ—¶å€™ï¼Œä½ å¯ä»¥ä½¿ç”¨ `context.register_task` æ³¨å†Œä¸€ä¸ªä»»åŠ¡ã€‚

åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå°†æ¼”ç¤ºä¸€ä¸ªæ¯éš” 5 ç§’å‘é€ä¸€æ¬¡æ¶ˆæ¯çš„ä»»åŠ¡ã€‚

```py
import asyncio
from util.plugin_dev.api.v1.bot import Context, AstrMessageEvent, CommandResult
from util.plugin_dev.api.v1.config import *
from util.plugin_dev.api.v1.platform import *

class HelloWorldPlugin:
    def __init__(self, context: Context) -> None:
        self.context = context
        self.context.register_task(self.send_msg_per_minute(), "send_msg_per_minute") # æ³¨å†Œä»»åŠ¡
    
    async def send_msg_per_minute(self):
        while True:
            await asyncio.sleep(5)
            for platform in self.context.platforms: # éå†æ‰€æœ‰å¹³å°
                if platform.platform_name == 'aiocqhttp': # aiocqhttp
                    inst = platform.platform_instance # è·å–å¹³å°å®ä¾‹
                    await inst.send_msg({"user_id": 905617992}, CommandResult().message("ä½ å¥½")) # å‘é€æ¶ˆæ¯ç»™qqå·ä¸º905617992çš„ç”¨æˆ·
        
```
ä¸Šé¢çš„ä¾‹å­ä½¿ç”¨äº†å¼‚æ­¥çš„æ–¹å¼æ¥å®ç°å®šæ—¶ä»»åŠ¡ã€‚å½“ç„¶å¯ä»¥ä½¿ç”¨ threading.Thread æ¥å®ç°ï¼Œä¸è¿‡ä¸æ¨èã€‚

## Context

æ’ä»¶å¤„ç†å‡½æ•°çš„å‚æ•°ä¹‹ä¸€ã€‚

å®ƒæ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒåŒ…å«äº† AstrBot å®ä¾‹ä¸­çš„ä¸€äº›å…±äº«æ•°æ®ã€‚

åœ¨æ’ä»¶ç±»çš„ `__init__` æ–¹æ³•ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ `context` å‚æ•°è·å–åˆ°è¿™ä¸ªå¯¹è±¡ã€‚

### æ³¨å†Œå¼‚æ­¥ä»»åŠ¡

å¦‚æœä½ éœ€è¦æ¥å…¥ä¸€ä¸ªå…¶ä»–çš„å¹³å°ï¼Œæˆ–è€…éœ€è¦å®šæ—¶ä»»åŠ¡ç­‰ï¼Œé™¤äº†ç›´æ¥ä½¿ç”¨ threading.Thread ä¹‹å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ context.register_task æ³¨å†Œä¸€ä¸ªä»»åŠ¡ã€‚

## AstrMessageEvent

æ’ä»¶å¤„ç†å‡½æ•°çš„å‚æ•°ä¹‹ä¸€ã€‚

å½“ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼ŒAstrBot ä¼šå°è£…å¥½æ¶ˆæ¯ï¼Œå½¢æˆ AstrMessageEvent å¯¹è±¡ï¼Œä¼ é€’ç»™æ’ä»¶ã€‚

- context: Context ä¸€äº›å…¬ç”¨æ•°æ®
- message_str: str çº¯æ¶ˆæ¯å­—ç¬¦ä¸²
- message_obj: AstrBotMessage æ¶ˆæ¯å¯¹è±¡
- platform: RegisteredPlatform æ¥æºå¹³å°
- role: str åŸºæœ¬èº«ä»½ã€‚`admin` æˆ– `member`
- session_id: int ä¼šè¯ id

### AstrBotMessage

è¿™æ˜¯æœºå™¨äººå†…éƒ¨çš„æ¶ˆæ¯å¯¹è±¡ï¼ˆv3.1.10 åï¼‰ï¼Œä¼šå¯¹æ¯ä¸ªå¹³å°åŸæœ¬çš„æ¶ˆæ¯ç±»è¿›è¡Œè½¬è¯‘ã€‚åŸå¹³å°çš„æ¶ˆæ¯ç±»åœ¨ `raw_message` ä¸­ã€‚

```py
tag: str # æ¶ˆæ¯æ¥æºæ ‡ç­¾
type: MessageType # æ¶ˆæ¯ç±»å‹ï¼ŒGROUP_MESSAGEã€FRIEND_MESSAGEã€GUILD_MESSAGE
self_id: str # æœºå™¨äººçš„è¯†åˆ«id
session_id: str # ä¼šè¯id
message_id: str # æ¶ˆæ¯id
sender: MessageMember # å‘é€è€…ï¼Œuser_id å’Œ nickname
message: List[BaseMessageComponent] # æ¶ˆæ¯é“¾ä½¿ç”¨ Nakuru çš„æ¶ˆæ¯é“¾æ ¼å¼
message_str: str # æœ€ç›´è§‚çš„çº¯æ–‡æœ¬æ¶ˆæ¯å­—ç¬¦ä¸²
raw_message: object åŸå¹³å°çš„æ¶ˆæ¯ç±»
timestamp: int # æ¶ˆæ¯æ—¶é—´æˆ³
```


ğŸš§ æ–½å·¥ä¸­ ğŸš§
